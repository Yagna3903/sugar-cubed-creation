# .github/workflows/ci-and-deploy.yml
name: CI + Deploy to Vercel (main)

on:
  push:
    branches: [ main ]         # any push to main redeploys
  workflow_dispatch: {}        # manual run if needed

concurrency:
  group: vercel-deploy-main
  cancel-in-progress: true

permissions:
  contents: read

env:
  NEXT_TELEMETRY_DISABLED: 1
  PRISMA_HIDE_UPDATE_MESSAGE: 1

jobs:
  ci:
    name: Lint • Typecheck • Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Generate Prisma client
        run: npx prisma generate

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npx tsc --noEmit

      - name: Test with coverage
        run: npm run test -- --coverage

      - name: Upload coverage (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ github.run_id }}
          path: coverage/
          if-no-files-found: ignore

  deploy:
    name: Trigger Vercel Deployment
    runs-on: ubuntu-latest
    needs: ci                   # only deploy if CI passed
    if: ${{ needs.ci.result == 'success' }}

    steps:
      - name: Validate Vercel Deploy Hook secret
        run: |
          if [ -z "${{ secrets.VERCEL_DEPLOY_HOOK_URL }}" ]; then
            echo "ERROR: VERCEL_DEPLOY_HOOK_URL is not set in GitHub Secrets."
            exit 1
          fi

      - name: Trigger Vercel Deploy Hook (with retries)
        id: vercel
        env:
          HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
        run: |
          # optional JSON payload so Vercel logs show commit context
          payload=$(jq -n \
            --arg sha "${GITHUB_SHA}" \
            --arg ref "${GITHUB_REF_NAME}" \
            --arg repo "${GITHUB_REPOSITORY}" \
            '{github:{sha:$sha, ref:$ref, repo:$repo}}')

          # fire hook with retries and error handling
          http_code=$(curl -sS -o /tmp/vercel_resp.json -w "%{http_code}" \
            --retry 5 --retry-all-errors --max-time 120 \
            -X POST "$HOOK_URL" \
            -H "Content-Type: application/json" \
            --data "$payload")

          echo "HTTP $http_code"
          echo "Response:"
          cat /tmp/vercel_resp.json || true

          if [ "$http_code" -ne 200 ] && [ "$http_code" -ne 201 ]; then
            echo "Vercel deploy hook failed."
            exit 1
          fi

      - name: Done
        run: echo "Vercel deploy successfully triggered."
